version: '3'

services:
  nats:
    image: nats:2.1.6-alpine3.11
    logging:
      driver: json-file
  torproxy:
    image: dperson/torproxy:latest
    logging:
      driver: none
  elasticsearch:
    image: elasticsearch:7.5.1
    logging:
      driver: none
    ports:
      - 9200:9200
    environment:
      - discovery.type=single-node
      - JAVA_OPTS=-Xms2g -Xmx2g
  kibana:
    image: kibana:7.5.1
    logging:
      driver: none
    depends_on:
      - elasticsearch
    ports:
      - 15004:5601
  crawler:
    image: trandoshan.io/crawler:latest
    command: --log-level debug --nats-uri nats --tor-uri torproxy:9050 --crawler-count 3
    restart: always
    depends_on:
      - nats
      - torproxy
      - api
  feeder:
   image: trandoshan.io/feeder:latest
   command: --log-level debug --nats-uri nats --url https://www.facebookcorewwwi.onion
   volumes:
      - /home/bcit/urls:/etc/urls/
   depends_on:
    - crawler
    - api
  scheduler:
    image: trandoshan.io/scheduler:latest
    command: --log-level debug --nats-uri nats --api-uri http://api:8080
    restart: always
    depends_on:
      - nats
  persister:
    image: trandoshan.io/persister:latest
    command: --log-level debug --nats-uri nats --api-uri http://api:8080
    restart: always
    depends_on:
      - nats
      - api
  api:
    image: trandoshan.io/api:latest
    command: --log-level debug --elasticsearch-uri http://elasticsearch:9200 --database_collection trandoshan-crawled
    restart: always
    ports:
      - 8080:8080
    depends_on:
      - elasticsearch